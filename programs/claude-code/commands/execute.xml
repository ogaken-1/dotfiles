<?xml version="1.0" encoding="UTF-8"?>
<command>
  <purpose>ポリシー決定とオーケストレーションに集中しながら、詳細な作業をサブエージェントに委任してタスクを実行する。</purpose>
  <rules priority="critical">
    <rule>テストファーストワークフローを適用するためにcodingエージェントを使用する</rule>
    <rule>詳細な作業を専門のサブエージェントに委任する</rule>
    <rule>オーケストレーションとポリシー決定に集中する</rule>
    <rule>独立したタスクを並列実行する</rule>
    <rule>統合前にサブエージェントの出力を検証する</rule>
  </rules>
  <rules priority="standard">
    <rule>委任パターンにはexecution-workflowスキルを使用する</rule>
    <rule>十分な場合は基本ツール（Read/Edit/Write）をCodex MCPより優先する</rule>
    <rule>コード生成/修正にのみCodex MCPを使用する</rule>
    <rule>実装前にSerenaメモリを確認する</rule>
  </rules>
  <workflow>
    <phase name="analyze">
      <objective>タスクの範囲を理解し、必要なリソースを特定する</objective>
      <step order="1">どのタスクを実行する必要があるか？</step>
      <step order="2">どのサブエージェントが最適か？</step>
      <step order="3">どのタスクを並列実行できるか？</step>
      <step order="4">タスク間にどのような依存関係があるか？</step>
      <step order="5">どのような検証が必要か？</step>
    </phase>
    <phase name="decompose">
      <objective>複雑なタスクを管理可能な単位に分解する</objective>
      <step order="1">管理可能な単位に分割する</step>
      <step order="2">タスクの境界を特定する</step>
    </phase>
    <phase name="structure">
      <objective>最適な実行のためにタスクを整理する</objective>
      <step order="1">並列タスクと逐次タスクを特定する</step>
      <step order="2">タスクの依存関係を定義する</step>
    </phase>
    <reflection_checkpoint id="analysis_quality">
      <question>十分な証拠を収集したか？</question>
      <question>理解に不足がないか？</question>
      <threshold>信頼度が70未満の場合、さらに証拠を収集するかユーザーに確認する</threshold>
    </reflection_checkpoint>
    <phase name="assign">
      <objective>明確な指示とともにタスクを適切なサブエージェントに委任する</objective>
      <step order="1">詳細な指示とともにタスクを委任する</step>
      <step order="2">コンテキストと制約を提供する</step>
    </phase>
    <reflection_checkpoint id="assignment_complete" after="assign">
      <questions>
        <question weight="0.4">すべてのタスクが適切に委任されたか？</question>
        <question weight="0.3">サブエージェントへの指示は明確か？</question>
        <question weight="0.3">タスク間の依存関係が処理されているか？</question>
      </questions>
      <threshold min="70" action="proceed">
        <below_threshold>タスク割り当てを精緻化するかユーザーに確認する</below_threshold>
      </threshold>
    </reflection_checkpoint>
    <phase name="failure_handling">
      <objective>エラーとエッジケースを適切に処理する</objective>
      <step order="1">ツール呼び出しが失敗した場合：エラーをログに記録し、代替アプローチを試行する</step>
      <step order="2">データが利用できない場合：ギャップを文書化し、部分的な分析で続行する</step>
      <step order="3">矛盾する証拠がある場合：不確実性をフラグし、ユーザーに確認を求める</step>
    </phase>
    <phase name="consolidate">
      <objective>サブエージェントの出力を統合して一貫した結果にまとめる</objective>
      <step order="1">サブエージェントの出力を検証する</step>
      <step order="2">結果を統合する</step>
    </phase>
  </workflow>
  <agents>
    <agent name="coding" subagent_type="coding" readonly="false">テストファーストワークフローでの実装（テスト → レビュー → 実装）</agent>
    <agent name="quality" subagent_type="quality-assurance" readonly="false">構文、型、フォーマットの検証</agent>
    <agent name="security" subagent_type="security" readonly="false">脆弱性検出</agent>
    <agent name="test" subagent_type="test" readonly="false">テスト作成、カバレッジ</agent>
    <agent name="refactor" subagent_type="general-purpose" readonly="false">リファクタリング、技術的負債</agent>
    <agent name="docs" subagent_type="docs" readonly="false">ドキュメント更新</agent>
    <agent name="review" subagent_type="quality-assurance" readonly="false">実装後レビュー</agent>
    <agent name="debug" subagent_type="general-purpose" readonly="false">デバッグサポート</agent>
    <agent name="performance" subagent_type="performance" readonly="false">パフォーマンス最適化</agent>
    <agent name="clean" subagent_type="code-quality" readonly="false">デッドコード除去</agent>
    <agent name="error-handling" subagent_type="general-purpose" readonly="false">エラー処理パターン</agent>
    <agent name="migration" subagent_type="general-purpose" readonly="false">マイグレーション計画と実行</agent>
    <agent name="database" subagent_type="database" readonly="false">データベース設計と最適化</agent>
    <agent name="infrastructure" subagent_type="devops" readonly="false">インフラストラクチャ設計</agent>
    <agent name="ci-cd" subagent_type="devops" readonly="false">CI/CDパイプライン設計</agent>
    <agent name="observability" subagent_type="devops" readonly="false">ロギング、モニタリング、トレーシング</agent>
    <agent name="git" subagent_type="git" readonly="false">Gitワークフロー設計</agent>
    <agent name="memory" subagent_type="general-purpose" readonly="false">ナレッジベース管理</agent>
    <agent name="validator" subagent_type="validator" readonly="true">クロスバリデーションとコンセンサス検証</agent>
  </agents>
  <execution_graph>
    <sequential_phase id="coding_phase" depends_on="none">
      <agent>coding</agent>
      <reason>テストファースト：テストを作成/修正し、レビューを受け、その後実装する</reason>
    </sequential_phase>
    <parallel_group id="post_implementation" depends_on="coding_phase">
      <agent>test</agent>
      <agent>quality</agent>
      <agent>security</agent>
      <agent>docs</agent>
    </parallel_group>
    <sequential_phase id="review_phase" depends_on="post_implementation">
      <agent>review</agent>
      <reason>すべてのチェック完了後の最終レビュー</reason>
    </sequential_phase>
  </execution_graph>
  <delegation>
    <requirement>具体的な範囲と期待される成果物</requirement>
    <requirement>対象ファイルパス</requirement>
    <requirement>参照実装（具体的なパス）</requirement>
    <requirement>メモリチェック：パターン用に`mcp__serena__list_memories`</requirement>
  </delegation>
  <codex_usage>
    <allowed>コード生成（新規ファイル/関数）、コード修正（編集/リファクタリング）</allowed>
    <prohibited>
      <task alternative="Exploreエージェント、Serena MCP">リサーチ/分析</task>
      <task alternative="qualityエージェント">品質検証</task>
      <task alternative="securityエージェント">セキュリティ検証</task>
      <task alternative="testエージェント">テスト作成</task>
      <task alternative="docsエージェント">ドキュメンテーション</task>
      <task alternative="reviewエージェント">コードレビュー</task>
    </prohibited>
    <rule>十分な場合は基本ツールを優先する</rule>
    <rule>呼び出しごとに1つの明確で小さなタスク</rule>
    <rule>フェーズを分離：リサーチ → 設計 → 実装</rule>
    <rule>単一の呼び出しで複数ファイルを編集しない</rule>
  </codex_usage>
  <parallelization>
    <capability>
      <parallel_safe>true</parallel_safe>
      <read_only>false</read_only>
      <modifies_state>local</modifies_state>
    </capability>
    <execution_strategy>
      <max_parallel_agents>16</max_parallel_agents>
      <timeout_per_agent>300000</timeout_per_agent>
    </execution_strategy>
  </parallelization>
  <decision_criteria>
    <criterion name="confidence_calculation">
      <factor name="task_clarity" weight="0.3">
        <score range="90-100">受け入れ基準を含む明確な要件</score>
        <score range="70-89">明確な要件</score>
        <score range="50-69">一部曖昧さがある</score>
        <score range="0-49">不明確な要件</score>
      </factor>
      <factor name="implementation_quality" weight="0.4">
        <score range="90-100">すべてのテストが通過、コードレビュー済み</score>
        <score range="70-89">テストが通過</score>
        <score range="50-69">一部の問題が残る</score>
        <score range="0-49">重大な問題がある</score>
      </factor>
      <factor name="verification_completeness" weight="0.3">
        <score range="90-100">サブエージェントによる完全な検証</score>
        <score range="70-89">コア検証完了</score>
        <score range="50-69">部分的な検証</score>
        <score range="0-49">最小限の検証</score>
      </factor>
    </criterion>
    <validation_tests>
      <test name="fully_verified">
        <input>task_clarity=95, implementation_quality=90, verification_completeness=95</input>
        <calculation>(95*0.3)+(90*0.4)+(95*0.3) = 28.5+36+28.5 = 93</calculation>
        <expected_status>success</expected_status>
        <reasoning>テスト済みコードと完全な検証を伴う明確な要件は高い信頼度をもたらす</reasoning>
      </test>
      <test name="boundary_warning_79">
        <input>task_clarity=80, implementation_quality=75, verification_completeness=85</input>
        <calculation>(80*0.3)+(75*0.4)+(85*0.3) = 24+30+25.5 = 79.5</calculation>
        <expected_status>warning</expected_status>
        <reasoning>テストは通過するが一部の問題が残り、結果は79.5で警告をトリガー</reasoning>
      </test>
      <test name="boundary_success_80">
        <input>task_clarity=85, implementation_quality=75, verification_completeness=85</input>
        <calculation>(85*0.3)+(75*0.4)+(85*0.3) = 25.5+30+25.5 = 81</calculation>
        <expected_status>success</expected_status>
        <reasoning>加重平均81、成功閾値を満たす</reasoning>
      </test>
      <test name="boundary_error_59">
        <input>task_clarity=65, implementation_quality=55, verification_completeness=60</input>
        <calculation>(65*0.3)+(55*0.4)+(60*0.3) = 19.5+22+18 = 59.5</calculation>
        <expected_status>error</expected_status>
        <reasoning>加重平均59.5は60未満でエラーをトリガー</reasoning>
      </test>
      <test name="major_issues">
        <input>task_clarity=50, implementation_quality=45, verification_completeness=50</input>
        <calculation>(50*0.3)+(45*0.4)+(50\*0.3) = 15+18+15 = 48</calculation>
        <expected_status>error</expected_status>
        <reasoning>重大な問題を伴う不明確な要件は48となりエラーをトリガー</reasoning>
      </test>
    </validation_tests>
  </decision_criteria>
  <enforcement>
    <mandatory_behaviors>
      <behavior id="EXEC-B001" priority="critical">
        <trigger>実装前</trigger>
        <action>既存パターンについてSerenaメモリを確認する</action>
        <verification>出力にパターンチェックを含める</verification>
      </behavior>
      <behavior id="EXEC-B002" priority="critical">
        <trigger>実装後</trigger>
        <action>qualityおよびsecurityエージェントに検証を委任する</action>
        <verification>出力にエージェントレポートを含める</verification>
      </behavior>
    </mandatory_behaviors>
    <prohibited_behaviors>
      <behavior id="EXEC-P001" priority="critical">
        <trigger>常に</trigger>
        <action>サブエージェントへの委任なしで実装する</action>
        <response>操作をブロックし、専門エージェントに委任する</response>
      </behavior>
    </prohibited_behaviors>
  </enforcement>
  <error_escalation>
    <level severity="low">
      <example>軽微なコードスタイルの不整合</example>
      <action>レポートに記録し、続行する</action>
    </level>
    <level severity="medium">
      <example>テスト失敗または不明確な実装アプローチ</example>
      <action>問題を文書化し、AskUserQuestionを使用して確認する</action>
    </level>
    <level severity="high">
      <example>破壊的変更または重大な実装のブロッカー</example>
      <action>停止し、ユーザーに選択肢を提示する</action>
    </level>
    <level severity="critical">
      <example>セキュリティ脆弱性またはデータ損失のリスク</example>
      <action>操作をブロックし、ユーザーの明示的な承認を要求する</action>
    </level>
  </error_escalation>
  <related_commands>
    <command name="define">実装で不明確な要件が判明した場合</command>
    <command name="ask">実装に調査が必要な場合</command>
    <command name="bug">実装で予期しないエラーが発生した場合</command>
    <command name="feedback">実行完了後の作業レビュー</command>
    <command name="upstream">上流OSSへの貢献のための変更準備時</command>
  </related_commands>
  <related_skills>
    <skill name="execution-workflow">コア委任とオーケストレーションパターン</skill>
    <skill name="serena-usage">実装前に既存パターンについてメモリを確認する</skill>
    <skill name="testing-patterns">適切なテストカバレッジを確保する</skill>
  </related_skills>
  <constraints>
    <must>詳細な作業をサブエージェントに委任する</must>
    <must>独立したタスクを並列実行する</must>
    <must>統合前に出力を検証する</must>
    <avoid>詳細なロジックを直接実装する</avoid>
    <avoid>過去の実装に関する不要なコメント</avoid>
    <avoid>単一のCodex呼び出しで複数ファイルを編集する</avoid>
  </constraints>
</command>
