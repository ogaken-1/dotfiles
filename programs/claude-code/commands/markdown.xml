<?xml version="1.0" encoding="UTF-8"?>
<command>
  <purpose>他のコマンド（/define、/ask、/bug など）の結果をマークダウンファイルとして出力する。</purpose>
  <rules priority="critical">
    <rule>前回のコマンド実行結果を取得する</rule>
    <rule>コンテキストに基づいて出力ファイル名を決定する</rule>
    <rule>指定されたファイルパスがあればそれを使用する</rule>
    <rule>修正履歴や議論の過程は含めない</rule>
  </rules>
  <parallelization>
    <capability>
      <parallel_safe>true</parallel_safe>
      <read_only>false</read_only>
      <modifies_state>local</modifies_state>
    </capability>
    <execution_strategy>
      <max_parallel_agents>16</max_parallel_agents>
      <timeout_per_agent>180000</timeout_per_agent>
    </execution_strategy>
  </parallelization>
  <decision_criteria>
    <criterion name="confidence_calculation">
      <factor name="content_accuracy" weight="0.4">
        <score range="90-100">すべてのコンテンツがソースに対して検証済み</score>
        <score range="70-89">コアコンテンツが検証済み</score>
        <score range="50-69">部分的に検証済み</score>
        <score range="0-49">未検証のコンテンツ</score>
      </factor>
      <factor name="structure_quality" weight="0.3">
        <score range="90-100">明確な階層構造、適切なフォーマット</score>
        <score range="70-89">良好な構造</score>
        <score range="50-69">基本的な構造</score>
        <score range="0-49">構造が不十分</score>
      </factor>
      <factor name="completeness" weight="0.3">
        <score range="90-100">要求されたすべてのコンテンツを含む</score>
        <score range="70-89">主要なコンテンツを含む</score>
        <score range="50-69">部分的なコンテンツ</score>
        <score range="0-49">不完全</score>
      </factor>
    </criterion>
    <validation_tests>
      <test name="clear_delegation">
        <input>content_accuracy=95, structure_quality=90, completeness=95</input>
        <calculation>(95*0.4)+(90*0.3)+(95*0.3) = 38+27+28.5 = 93.5</calculation>
        <expected_status>success</expected_status>
        <reasoning>明確な構造で検証済みのコンテンツは高い信頼度をもたらす</reasoning>
      </test>
      <test name="boundary_warning_79">
        <input>content_accuracy=80, structure_quality=75, completeness=80</input>
        <calculation>(80*0.4)+(75*0.3)+(80*0.3) = 32+22.5+24 = 78.5</calculation>
        <expected_status>warning</expected_status>
        <reasoning>コアコンテンツは検証済みだが構造に問題があり、結果は78.5で警告をトリガー</reasoning>
      </test>
      <test name="boundary_success_80">
        <input>content_accuracy=85, structure_quality=75, completeness=80</input>
        <calculation>(85*0.4)+(75*0.3)+(80*0.3) = 34+22.5+24 = 80.5</calculation>
        <expected_status>success</expected_status>
        <reasoning>加重平均80.5、成功閾値を満たす</reasoning>
      </test>
      <test name="boundary_error_59">
        <input>content_accuracy=60, structure_quality=55, completeness=60</input>
        <calculation>(60*0.4)+(55*0.3)+(60*0.3) = 24+16.5+18 = 58.5</calculation>
        <expected_status>error</expected_status>
        <reasoning>加重平均58.5は60未満でエラーをトリガー</reasoning>
      </test>
      <test name="unverified_content">
        <input>content_accuracy=50, structure_quality=55, completeness=45</input>
        <calculation>(50*0.4)+(55*0.3)+(45\*0.3) = 20+16.5+13.5 = 50</calculation>
        <expected_status>error</expected_status>
        <reasoning>構造が不十分で未検証のコンテンツは50となりエラーをトリガー</reasoning>
      </test>
    </validation_tests>
  </decision_criteria>
  <workflow>
    <phase name="analyze">
      <objective>前回のコマンド出力とコンテキストを理解する</objective>
      <step>1. 前回のコマンドは何だったか？</step>
      <step>2. 適切な出力ファイルは何か？</step>
      <step>3. 特定のファイルパスが指定されたか？</step>
      <step>4. どのコンテンツを含め、どれを除外すべきか？</step>
    </phase>
    <reflection_checkpoint id="analyze_quality">
      <question>前回のコマンドとその出力を正しく特定したか？</question>
      <question>どのコンテンツを文書化する必要があるか理解しているか？</question>
      <threshold>信頼度が70未満の場合、さらに証拠を収集するかユーザーに確認する</threshold>
    </reflection_checkpoint>
    <phase name="gather">
      <objective>ドキュメンテーションに必要なすべての関連情報を取得する</objective>
      <step>1. 前回のコマンド結果を取得する</step>
      <step>2. 関連するコンテキストを収集する</step>
    </phase>
    <reflection_checkpoint id="analysis_quality">
      <question>十分な証拠を収集したか？</question>
      <question>理解に不足がないか？</question>
      <threshold>信頼度が70未満の場合、さらに証拠を収集するかユーザーに確認する</threshold>
    </reflection_checkpoint>
    <phase name="determine">
      <objective>出力ファイルの場所と構造を決定する</objective>
      <step>1. コマンドタイプに基づいて出力ファイル名を決定する</step>
      <step>2. ユーザーがファイルパスを指定したか確認する</step>
    </phase>
    <phase name="failure_handling">
      <objective>エラーとエッジケースを適切に処理する</objective>
      <step>1. サブエージェントが失敗した場合：エラーをログに記録し、代替アプローチを試行する</step>
      <step>2. データが利用できない場合：ギャップを文書化し、部分的な分析で続行する</step>
      <step>3. 矛盾する証拠がある場合：不確実性をフラグし、ユーザーに確認を求める</step>
    </phase>
    <phase name="execute">
      <objective>ドキュメントをファイルに書き込む</objective>
      <step>1. Write/Editツールを使用してファイルを書き込む</step>
      <step>2. 出力形式を確認する</step>
    </phase>
  </workflow>
  <agents>
    <agent name="docs" subagent_type="docs" readonly="false">ドキュメンテーション管理</agent>
    <agent name="memory" subagent_type="general-purpose" readonly="false">Serenaメモリへのナレッジベース記録</agent>
  </agents>
  <execution_graph>
    <sequential_phase id="output" depends_on="none">
      <agent>docs</agent>
      <reason>最初にマークダウンファイルを作成する</reason>
    </sequential_phase>
    <sequential_phase id="memory_recording" depends_on="output">
      <agent>memory</agent>
      <reason>ファイル作成後にナレッジベースに記録する</reason>
    </sequential_phase>
  </execution_graph>
  <output>
    <format>
      <markdown_file>
        <header>コマンド出力に基づくタイトル</header>
        <content>前回のコマンドからのクリーンでフォーマット済みの出力</content>
        <footer>オプション：関連する参照</footer>
      </markdown_file>
    </format>
  </output>
  <enforcement>
    <mandatory_behaviors>
      <behavior id="MD-B001" priority="critical">
        <trigger>ドキュメンテーション作成前</trigger>
        <action>ソース資料を理解する</action>
        <verification>出力にソース分析を含める</verification>
      </behavior>
      <behavior id="MD-B002" priority="critical">
        <trigger>コード例を含める場合</trigger>
        <action>例が正確で実行可能であることを確認する</action>
        <verification>例の検証を記録する</verification>
      </behavior>
    </mandatory_behaviors>
    <prohibited_behaviors>
      <behavior id="MD-P001" priority="critical">
        <trigger>常に</trigger>
        <action>ドキュメントへのタイムスタンプ追加</action>
        <response>操作をブロック、タイムスタンプは禁止されている</response>
      </behavior>
    </prohibited_behaviors>
  </enforcement>
  <error_escalation>
    <level severity="low">
      <example>出力の軽微なフォーマットの不整合</example>
      <action>レポートに記録し、続行する</action>
    </level>
    <level severity="medium">
      <example>不明確な出力先または曖昧なファイルマッピング</example>
      <action>問題を文書化し、AskUserQuestionを使用して確認する</action>
    </level>
    <level severity="high">
      <example>ファイルパスの競合または上書きのリスク</example>
      <action>停止し、ユーザーに選択肢を提示する</action>
    </level>
    <level severity="critical">
      <example>重要なドキュメントを上書きするリスク</example>
      <action>操作をブロックし、ユーザーの明示的な承認を要求する</action>
    </level>
  </error_escalation>
  <related_commands>
    <command name="ask">RESEARCH.md出力の主要なソース</command>
    <command name="bug">RESEARCH.md出力の主要なソース</command>
  </related_commands>
  <related_skills>
    <skill name="technical-documentation">マークダウン出力のフォーマットと構造化</skill>
    <skill name="serena-usage">必要に応じてメモリにナレッジを記録</skill>
  </related_skills>
  <file_mapping>
    <default_output_dir>プロジェクトルート</default_output_dir>
    <mapping command="/ask" output="RESEARCH.md"/>
    <mapping command="/bug" output="RESEARCH.md"/>
    <mapping command="other" output="MEMO.md"/>
    <note>ユーザー指定のファイルパスが優先される</note>
  </file_mapping>
  <constraints>
    <must>コンテキストに適したファイル名を使用する</must>
    <must>ユーザー指定のファイルパスを尊重する</must>
    <avoid>修正履歴/変更ログを含める</avoid>
    <avoid>検討過程/議論の履歴を含める</avoid>
  </constraints>
</command>
